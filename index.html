<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>çµ‚æ¥µå¯©åˆ¤ï¼šé›»è»Šé›£é¡Œ â€” åˆ†å‰è»Œé“ Demo</title>
<style>
  :root{ --bg:#0b1020; --panel:#0f1630; --line:#1f2a55; --fg:#e6edf3; --muted:#9aa7bd; --card:#17213f; --accent:#5bd1ff; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr}
  header{padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--line)}
  h1{font-size:18px;margin:0}
  .btn{cursor:pointer;border:1px solid #2a355f;background:#121a36;color:var(--fg);padding:8px 12px;border-radius:10px}
  .btn[disabled]{opacity:.5;cursor:not-allowed}

  .statusbar{display:flex;gap:10px;align-items:center;margin-left:auto;flex-wrap:wrap}
  .statusItem{font-size:20px;font-weight:900;padding:8px 14px;border-radius:14px;color:#fff}
  .statusItem.player{background:#20305f}
  .statusItem.phase{background:#22532a}

  .board{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}

  .stage{position:relative;background:#0d1533 center/cover no-repeat;border:1px solid var(--line);border-radius:16px;overflow:hidden;min-height:560px;transition:background-image .25s ease}
  .stage.has-bg{background-image:url('assets/track.png');}
  .legend{position:absolute;inset:auto 12px 12px 12px;color:#c3cfe6;font-size:13px;text-shadow:0 1px 0 rgba(0,0,0,.2)}

  .lane{position:absolute;display:flex;gap:12px;align-items:flex-end;transform-origin:left center}
  .lane.A{top:120px;left:285px;transform:rotate(-8deg)}
  .lane.B{bottom:118px;left:285px;transform:rotate(8deg)}

  .card{background:var(--card);border:1px solid #2b3a6b;border-radius:10px;padding:6px 8px;min-width:150px;max-width:240px;position:relative;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .card .type{font-size:12px;color:var(--muted)}
  .card .title{font-weight:700}
  .mods{margin-top:4px;display:flex;flex-direction:column;gap:2px}
  .mod{font-size:11px;background:#1a2548;border:1px solid #33437a;border-radius:8px;padding:2px 6px;color:#cfe4ff;align-self:flex-start}

  .card.destroyed{position:relative;overflow:hidden;animation:tearExit .6s ease forwards;filter:saturate(.7) contrast(1.1)}
  .card.destroyed::before{content:"";position:absolute;inset:-8px;background:url('assets/blood_splash.png') center/cover no-repeat;mix-blend-mode:screen;opacity:.9}
  @keyframes tearExit{0%{transform:rotate(0) scale(1);opacity:1}100%{transform:rotate(14deg) scale(.85);opacity:0}}

  .tabbar{display:flex;gap:8px;margin-top:6px}
  .tab{display:inline-flex;align-items:center;padding:6px 12px;border-radius:10px;border:1px solid #2a355f;background:#111834;cursor:pointer;user-select:none}
  .tab.active{background:#21306a;color:#cfe4ff;box-shadow:0 0 0 2px rgba(91,209,255,.35) inset}
  .hand{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
  .cardBtn{background:#161f3e;border:1px solid #2a355f;border-radius:10px;padding:8px 10px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .cardBtn .tag{font-size:12px;opacity:.9;border:1px solid #2a355f;padding:2px 8px;border-radius:999px}
  .cardBtn.sel{outline:2px solid var(--accent);box-shadow:0 0 0 2px rgba(91,209,255,.25)}
  .log{background:#0e152f;border:1px solid var(--line);border-radius:12px;padding:8px;height:220px;overflow:auto;white-space:pre-wrap;color:#cdd9e5}

  .dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:20}
  .dialog .box{background:#0f1630;border:1px solid #2a355f;border-radius:14px;padding:16px;min-width:260px;text-align:center}
  .choiceRow{display:flex;gap:10px;justify-content:center;margin-top:12px}
  .bigChoice{flex:1;padding:10px 14px;border-radius:10px;border:1px solid #30407a;background:#14204a;color:#fff;cursor:pointer;font-size:18px}
  .bigChoice.active{outline:2px solid var(--accent)}

  .trolley{
    position:absolute;width:140px;pointer-events:none;
    filter:drop-shadow(0 6px 12px rgba(0,0,0,.4));
    opacity:1;offset-rotate:auto;offset-distance:0%;z-index:2;
  }
  .trolley.run { animation: trolleyRun var(--trolley-dur, 2400ms) linear forwards; }
  @keyframes trolleyRun { from{offset-distance:0%} to{offset-distance:100%} }

  @media (max-width: 900px){ .board{ grid-template-columns: 1fr; } .stage{ min-height: 60vh; } }
  .force-landscape .board{ grid-template-columns: minmax(0, 1fr) 42vw; gap:10px; }
  .force-landscape .stage{ min-height: calc(100vh - 110px); }
  .force-landscape .side{ height: calc(100vh - 110px); overflow:auto; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸšï¸ é›»è»Šé›£é¡Œ â€” åˆ†å‰è»Œé“</h1>
      <div class="statusbar">
        <div class="statusItem player">ç©å®¶ï¼š<span id="turnPlayer">A</span></div>
        <div class="statusItem phase">éšæ®µï¼š<span id="phaseLabel">éš¨æ©Ÿå–„å·²æ”¾ / é¸å–„</span></div>
        <button class="btn" id="btnSwitch" disabled>åˆ‡æ›ç©å®¶</button>
        <button class="btn" id="btnNext" disabled>é€²å…¥è£æ±º</button>
        <button class="btn" id="btnJudge" disabled>åˆ—è»Šé•·è£æ±º</button>
        <button class="btn" id="btnRotate">æ¨ªå±æ˜¾ç¤º</button>
        <button class="btn" id="btnReset">é‡ç½®å›åˆ</button>
      </div>
    </header>

    <main class="board">
      <section class="stage has-bg" id="stage">
        <img id="trolley" class="trolley" src="assets/trolley.png" alt="trolley" />
        <div class="lane A" id="laneA" data-side="A"></div>
        <div class="lane B" id="laneB" data-side="B"></div>
        <div class="legend">æ¯æ¢è»Œé“ä¸‰å¼µï¼š1 éš¨æ©Ÿå–„ â†’ 2 ç©å®¶é¸å–„ â†’ 3 ç©å®¶é¸æƒ¡ â†’ ç‰¹æ€§ â†’ è£æ±ºã€‚</div>
      </section>

      <aside class="side">
        <div class="panel">
          <div class="tabbar">
            <div class="tab" data-tab="innocent">å–„è‰¯å¡</div>
            <div class="tab" data-tab="guilty">é‚ªæƒ¡å¡</div>
            <div class="tab" data-tab="modifier">ç‰¹æ€§å¡</div>
          </div>
          <div id="hand" class="hand"></div>
        </div>
        <div class="panel">
          <strong>æ“ä½œè¨˜éŒ„</strong>
          <div id="log" class="log"></div>
        </div>
      </aside>
    </main>

    <div class="dialog" id="judgeDlg">
      <div class="box">
        <div style="font-weight:800;font-size:18px">åˆ—è»Šé•·è£æ±º</div>
        <div style="margin-top:6px;color:#cbd5e1">è«‹é¸æ“‡è¦æ’çš„è»Œé“</div>
        <div class="choiceRow">
          <button class="bigChoice" data-side="A">æ’ A è»Œé“</button>
          <button class="bigChoice" data-side="B">æ’ B è»Œé“</button>
        </div>
        <div class="choiceRow"><button class="btn" id="btnConfirmJudge" disabled>ç¢ºå®š</button></div>
      </div>
    </div>
  </div>

<script>
/* ------------------- ç‹€æ…‹ ------------------- */
const state = {
  turn:'A',
  hands:{
    A:{innocent:['å¤©æ‰é†«ç”Ÿ','å¹¼å…’åœ’è€å¸«','æ°£å€™ç§‘å­¸å®¶'],
       guilty:['é€ƒçŠ¯','é‚ªæ•™é ­ç›®','ç¶²è·¯è©é¨™çŠ¯'],
       modifier:['å…¶å¯¦æ˜¯ä½ è¡¨è¦ª','åªæœ‰ä¸€é€±å£½å‘½','å…¶ç ”ç©¶å°‡æ‹¯æ•‘ç™¾è¬äºº']},
    B:{innocent:['æ¶ˆé˜²å“¡','æµæµªè²“æ•‘åŠ©è€…','å¿—é¡˜è€…'],
       guilty:['çµäººå·çµè€…','æˆ°çŠ¯','æƒ¡éœ¸æˆ¿æ±'],
       modifier:['æš—åœ°è£¡è³‡åŠ©æ…ˆå–„','å…¶å¯¦æ˜¯AIè¤‡è£½é«”','æœƒç™¼æ˜æ¸…æ½”èƒ½æº']},
  },
  deck:{ // éš¨æ©Ÿå–„å¾ç‰Œåº«æŠ½ï¼Œä¸æ¶ˆè€—æ‰‹ç‰Œ
    innocent:['åœ–æ›¸é¤¨å“¡','æ•‘ç”Ÿå“¡','å¿—å·¥è­·å£«','å–„è‰¯é„°å±…','ç„¡è¾œè·¯äºº','å°é®è€å¸«','å‹•ä¿å¿—å·¥','ç¤¾å·¥','ç§‘å­¸å®¶åŠ©ç†'],
    guilty:['è©é¨™é›†åœ˜è»Šæ‰‹','å·çµè€…','ç ´å£è€…','ç¶²è·¯éœ¸å‡Œè€…'],
    modifier:['å…¶å¯¦æ˜¯ä½ é æˆ¿è¦ªæˆš','æš—ä¸­ææ¬¾è€…','å³å°‡æ‰¾åˆ°æ²»ç™‚æ–¹æ³•']
  },
  lanes:{A:[],B:[]},
  activeTab:'innocent',
  selected:null,
  phase:'innocent',              // innocent(ç¬¬2å¼µ) â†’ guilty(ç¬¬3å¼µ) â†’ modifier â†’ judge â†’ end
  requirements:{A:{inn2:false,g3:false},B:{inn2:false,g3:false}},
  judgePick:null
};
const initialHands = JSON.parse(JSON.stringify(state.hands));
const initialDeck  = JSON.parse(JSON.stringify(state.deck));

/* ------------------- DOM ------------------- */
const handEl=document.getElementById('hand');
const laneA=document.getElementById('laneA');
const laneB=document.getElementById('laneB');
const logEl=document.getElementById('log');
const phaseLabel=document.getElementById('phaseLabel');
const btnNext=document.getElementById('btnNext');
const btnJudge=document.getElementById('btnJudge');
const btnSwitch=document.getElementById('btnSwitch');
const btnRotate=document.getElementById('btnRotate');
const turnPlayer=document.getElementById('turnPlayer');
const stageEl=document.getElementById('stage');
const judgeDlgEl=document.getElementById('judgeDlg');
const btnConfirmJudge=document.getElementById('btnConfirmJudge');
const trolley=document.getElementById('trolley');

const other = p => p==='A' ? 'B' : 'A';
const tabLabel = t => t==='innocent'?'å–„': t==='guilty'?'æƒ¡':'ç‰¹';
const phaseName = p=> p==='innocent'?'é¸å–„ï¼ˆç¬¬äºŒå¼µï¼‰': p==='guilty'?'é¸æƒ¡ï¼ˆç¬¬ä¸‰å¼µï¼‰': p==='modifier'?'ç‰¹æ€§å¡': p==='judge'?'è£æ±º':'çµæŸ';
function log(m){ logEl.textContent += `${new Date().toLocaleTimeString()} ${m}
`; logEl.scrollTop = logEl.scrollHeight; }

/* ------------------- åˆ—è»Šè·¯å¾‘ï¼ˆè‡ªé©æ‡‰èƒŒæ™¯å°ºå¯¸ï¼‰ ------------------- */
function setTrolleyPaths(){
  const W = stageEl.clientWidth;
  const H = stageEl.clientHeight;

  // èµ·é»ï¼šå·¦å´ä¸»å¹¹é“ä¸­ç·šé™„è¿‘ï¼ˆæŒ‰èƒŒæ™¯æ¯”ä¾‹å¾®èª¿ï¼‰
  const sx = 0.06*W, sy = 0.46*H;

  // ä¸Šæ”¯è·¯ï¼ˆAï¼‰ï¼šå‘å³ä¸Šå½
  const pathA = [
    `M ${sx},${sy}`,
    `C ${0.24*W},${0.42*H} ${0.52*W},${0.32*H} ${0.90*W},${0.22*H}`,
    `L ${0.98*W},${0.20*H}`
  ].join(' ');

  // ä¸‹æ”¯è·¯ï¼ˆBï¼‰ï¼šå‘å³ä¸‹å½
  const pathB = [
    `M ${sx},${sy}`,
    `C ${0.24*W},${0.50*H} ${0.52*W},${0.62*H} ${0.90*W},${0.78*H}`,
    `L ${0.98*W},${0.80*H}`
  ].join(' ');

  stageEl.dataset.pathA = pathA;
  stageEl.dataset.pathB = pathB;

  // é‡è¦ï¼šçµ¦åˆ—è»Šè³¦äºˆ offset-pathï¼Œä¸¦å¾©ä½åˆ°èµ·é»ï¼Œç¢ºä¿åˆå§‹å°±èƒ½çœ‹åˆ°
  trolley.style.offsetPath = `path('${pathA}')`;
  trolley.style.offsetDistance = '0%';
  trolley.classList.remove('run');
}

/* ------------------- åˆå§‹åŒ–ï¼šæ¯é‚Šéš¨æ©Ÿå–„ï¼ˆä¾†è‡ªç‰Œåº«ï¼‰ ------------------- */
function autoPlaceRandomInnocent(){
  ['A','B'].forEach(side=>{
    const pool = state.deck.innocent;
    const idx = Math.floor(Math.random()*pool.length);
    const title = pool.splice(idx,1)[0];
    state.lanes[side].push({title, type:'innocent', owner:side, mods:[], random:true});
    log(`ç³»çµ±ï¼šåœ¨è»Œé“ ${side} è‡ªç‰Œåº«æ”¾ç½®éš¨æ©Ÿã€å–„ã€‘ã€Œ${title}ã€ï¼ˆç¬¬1å¼µï¼‰`);
  });
  state.phase='innocent'; state.activeTab='innocent'; state.turn='A';
  updateHeader(); renderAll();
}

/* ------------------- æ‰‹ç‰Œ/å ´é¢æ¸²æŸ“ ------------------- */
function renderHand(){
  handEl.innerHTML='';
  const me = state.turn; const list = state.hands[me][state.activeTab];
  if(!list.length){ const d=document.createElement('div'); d.style.color='#9aa7bd'; d.textContent='ï¼ˆç„¡å¡ï¼‰'; handEl.appendChild(d); return; }
  list.forEach((title,i)=>{
    const btn=document.createElement('div'); btn.className='cardBtn';
    if(state.selected && state.selected.from===me && state.selected.type==='modifier' && state.selected.index===i) btn.classList.add('sel');
    btn.innerHTML = `<strong>${title}</strong><span class="tag">${tabLabel(state.activeTab)}</span>`;
    btn.onclick = ()=>{
      if(state.activeTab==='modifier' && state.phase==='modifier'){
        const already = state.selected && state.selected.from===me && state.selected.type==='modifier' && state.selected.index===i;
        state.selected = already ? null : {type:'modifier', title, from:me, index:i};
        renderHand(); if(state.selected) log(`é¸ä¸­ç‰¹æ€§å¡ï¼š${title}ï¼Œè«‹é»å ´ä¸Šç›®æ¨™å¡`);
      }else{
        playCard({type:state.activeTab,title,from:me,index:i});
      }
    };
    handEl.appendChild(btn);
  });
}

function renderLanes(){
  laneA.innerHTML=''; laneB.innerHTML='';
  state.lanes.A.forEach((c,i)=>laneA.appendChild(renderCardEl('A',i,c)));
  state.lanes.B.forEach((c,i)=>laneB.appendChild(renderCardEl('B',i,c)));
}
function renderCardEl(side, idx, card){
  const wrap=document.createElement('div'); wrap.className='card';
  const pos=idx+1;
  wrap.innerHTML = `<div class="type">${card.type==='innocent'?'å–„è‰¯':'é‚ªæƒ¡'}ãƒ»${card.owner}ãƒ»ç¬¬${pos}å¼µ</div><div class="title">${card.title}</div>`;
  const mods=document.createElement('div'); mods.className='mods';
  card.mods.forEach(m=>{ const d=document.createElement('div'); d.className='mod'; d.textContent=m.title; mods.appendChild(d); });
  wrap.appendChild(mods);

  if(state.phase==='modifier'){
    wrap.addEventListener('click',()=>{
      if(!(state.selected && state.selected.type==='modifier')) return;
      const s=state.selected; card.mods.push({title:s.title,owner:s.from});
      state.hands[s.from].modifier.splice(s.index,1); state.selected=null; renderAll();
      log(`åœ¨ã€Œ${card.title}ã€ä¸Šç–ŠåŠ ç‰¹æ€§ï¼š${card.mods.slice(-1)[0].title}`);
    }, true);
  }
  return wrap;
}

/* ------------------- å‡ºç‰Œ & éšæ®µæ¨é€² ------------------- */
function playCard(sel){
  if(!sel) return; const me=state.turn;
  if(state.phase==='innocent' && sel.type!=='innocent'){ log('ç•¶å‰éœ€è¦ã€å–„è‰¯å¡ã€‘'); return; }
  if(state.phase==='guilty'   && sel.type!=='guilty'){   log('ç•¶å‰éœ€è¦ã€é‚ªæƒ¡å¡ã€‘'); return; }

  let side=null;
  if(state.phase==='innocent'){ side=me;          state.requirements[me].inn2=true; }
  if(state.phase==='guilty'){   side=other(me);   state.requirements[me].g3=true;  }

  const card={title:sel.title,type:sel.type,owner:me,mods:[]};
  state.lanes[side].push(card);
  state.hands[sel.from][sel.type].splice(sel.index,1);

  renderAll();
  log(`ç©å®¶ ${me} åœ¨è»Œé“ ${side} æ”¾ç½®ç¬¬${state.phase==='innocent'?2:3}å¼µã€${tabLabel(sel.type)}ã€‘ã€Œ${sel.title}ã€`);

  // æ›æ‰‹ï¼ˆç›´åˆ°å°æ‰‹ä¹Ÿå®Œæˆæœ¬éšæ®µè¦æ±‚ï¼‰
  if(state.phase==='innocent'){ if(!state.requirements[other(me)].inn2) state.turn=other(me); }
  else if(state.phase==='guilty'){ if(!state.requirements[other(me)].g3) state.turn=other(me); }

  // æ¨é€²éšæ®µ
  if(state.phase==='innocent' && state.requirements.A.inn2 && state.requirements.B.inn2){
    state.phase='guilty'; state.turn='A'; state.activeTab='guilty'; updateHeader(); renderAll(); log('å·²é€²å…¥ã€é¸æƒ¡ï¼ˆç¬¬ä¸‰å¼µï¼‰ã€‘éšæ®µ');
  }else if(state.phase==='guilty' && state.requirements.A.g3 && state.requirements.B.g3){
    state.phase='modifier'; state.turn='A'; state.activeTab='modifier'; updateHeader(); renderAll(); log('å·²é€²å…¥ã€ç‰¹æ€§ã€‘éšæ®µï¼Œå®Œæˆå¾Œé»ã€Œé€²å…¥è£æ±ºã€');
  }else{
    updateHeader(); renderHand();
  }
}

/* ------------------- è£æ±º â†’ å°è©±æ¡† + åˆ—è»Šè¡Œé§› ------------------- */
btnNext.onclick = ()=>{ if(state.phase==='modifier'){ state.phase='judge'; updateHeader(); openJudgeDialog(); } };
btnJudge.onclick= ()=>{ if(state.phase==='judge')   openJudgeDialog(); };

function openJudgeDialog(){ state.judgePick=null; btnConfirmJudge.disabled=true; judgeDlgEl.style.display='flex'; }

document.querySelectorAll('.bigChoice').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.bigChoice').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); state.judgePick=b.dataset.side; btnConfirmJudge.disabled=false;
  });
});
btnConfirmJudge.addEventListener('click',()=>{
  if(!state.judgePick) return; judgeDlgEl.style.display='none';
  runTrolley(state.judgePick);
});

function runTrolley(side){
  log(`åˆ—è»Šé•·è£æ±ºï¼šæ’ ${side} è»Œé“`);

  // é¸æ“‡è·¯å¾‘ä¸¦å¾©ä½åˆ°èµ·é»
  const p = side==='A' ? stageEl.dataset.pathA : stageEl.dataset.pathB;
  trolley.style.offsetPath = `path('${p}')`;
  trolley.style.offsetDistance = '0%';

  // è§¸ç™¼é‹è¡Œå‹•ç•«
  trolley.style.setProperty('--trolley-dur','2400ms');
  trolley.classList.remove('run'); void trolley.offsetWidth; // é‡æ–°è¨ˆç®—
  trolley.classList.add('run');

  // ç¢¾å¡ï¼šæŒ‰å¡æ•¸å‡åˆ†æ™‚é–“é»ï¼Œé€å¼µè§¸ç™¼ destroyed
  const laneEl = side==='A' ? laneA : laneB;
  const cards = [...laneEl.querySelectorAll('.card')];
  const dur = 2400;
  const step = cards.length ? Math.floor(dur/cards.length) : 600;
  cards.forEach((el,i)=> setTimeout(()=> el.classList.add('destroyed'), i*step));

  const onEnd = ()=>{
    stageEl.style.backgroundImage = "url('assets/track_blood.png')";
    trolley.classList.remove('run');
    state.phase='end'; updateHeader();
    trolley.removeEventListener('animationend', onEnd);
  };
  trolley.addEventListener('animationend', onEnd);
}

/* ------------------- Header/Tabs/æŒ‰éˆ• ------------------- */
function phaseText(){ return state.phase==='innocent' ? 'éš¨æ©Ÿå–„å·²æ”¾ / é¸å–„' : phaseName(state.phase); }
function updateHeader(){
  turnPlayer.textContent=state.turn;
  phaseLabel.textContent=phaseText();
  btnNext.disabled   = state.phase!=='modifier';
  btnJudge.disabled  = state.phase!=='judge';
  btnSwitch.disabled = state.phase!=='modifier';
  btnSwitch.style.opacity = btnSwitch.disabled ? .5 : 1;
  document.querySelectorAll('.tab').forEach(el=>{
    const should = (state.phase==='innocent' && el.dataset.tab==='innocent')
                || (state.phase==='guilty'   && el.dataset.tab==='guilty')
                || (state.phase==='modifier' && el.dataset.tab==='modifier');
    el.classList.toggle('active', should);
    el.style.opacity = should?1:.45;
    el.style.pointerEvents = should?'auto':'none';
  });
  state.activeTab = (state.phase==='innocent')?'innocent' : (state.phase==='guilty')?'guilty' : (state.phase==='modifier')?'modifier' : state.activeTab;
}

/* åˆ‡æ›ç©å®¶ï¼ˆåƒ…ç‰¹æ€§éšæ®µï¼‰ */
btnSwitch.onclick = ()=>{
  if(state.phase!=='modifier') return;
  state.turn = other(state.turn);
  log(`åˆ‡æ›åˆ°ç©å®¶ ${state.turn} é€²è¡Œç‰¹æ€§æ“ä½œ`);
  updateHeader(); renderHand();
};

/* é‡ç½®å›åˆ */
document.getElementById('btnReset').onclick = ()=>{
  Object.assign(state,{
    turn:'A', lanes:{A:[],B:[]},
    hands:JSON.parse(JSON.stringify(initialHands)),
    deck: JSON.parse(JSON.stringify(initialDeck)),
    activeTab:'innocent', selected:null, phase:'innocent',
    requirements:{A:{inn2:false,g3:false},B:{inn2:false,g3:false}}, judgePick:null
  });
  stageEl.style.backgroundImage = "url('assets/track.png')";
  log('å·²é‡ç½®ï¼šå°‡é‡æ–°å¾ç‰Œåº«éš¨æ©Ÿæ”¾ç½®ç¬¬ä¸€å¼µå–„è‰¯å¡');
  updateHeader(); renderAll(); setTrolleyPaths(); autoPlaceRandomInnocent();
};

/* Tabsï¼šåƒ…ç•¶å‰éšæ®µå¯é»ï¼Œç”¨ä¾†åˆ·æ–°æ‰‹ç‰Œ */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{ if(!t.classList.contains('active')) return; state.activeTab=t.dataset.tab; renderHand(); });
});

/* æ©«å±é¡¯ç¤ºï¼ˆä¸æ—‹è½‰å…§å®¹ï¼Œåƒ…å¼·åˆ¶å…©åˆ—ä½ˆå±€ï¼‰ */
btnRotate.addEventListener('click', ()=>{
  const root = document.documentElement;
  const toggled = !root.classList.contains('force-landscape');
  root.classList.toggle('force-landscape', toggled);
  btnRotate.textContent = toggled ? 'è¿˜åŸç«–å±' : 'æ¨ªå±æ˜¾ç¤º';
  setTimeout(()=>{ setTrolleyPaths(); }, 60); // ä½ˆå±€è®Šæ›´å¾Œé‡ç®—è·¯å¾‘
});

/* å…¥å£ï¼šå…ˆè¨­ç½®è·¯å¾‘â†’æ¸²æŸ“â†’è‡ªå‹•éš¨æ©Ÿå–„ */
function renderAll(){ renderLanes(); renderHand(); updateHeader(); }
window.addEventListener('load', ()=>{ setTrolleyPaths(); renderAll(); autoPlaceRandomInnocent(); });
window.addEventListener('resize', setTrolleyPaths);
</script>
</body>
</html>
