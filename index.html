<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çµ‚æ¥µå¯©åˆ¤ï¼šé›»è»Šé›£é¡Œ â€” åˆ†å‰è»Œé“ Demo</title>
  <style>
    :root {
      --bg:#0b1020; --panel:#0f1630; --line:#1f2a55; --fg:#e6edf3; --muted:#9aa7bd;
      --card:#17213f; --accent:#5bd1ff; --danger:#ff6b6b; --ok:#65d38b; --warn:#ffc36b;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{padding:12px 16px}
    header{display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .btn{cursor:pointer;border:1px solid #2a355f;background:#121a36;color:var(--fg);padding:8px 12px;border-radius:10px}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .col{display:flex;gap:12px;align-items:center}

    /* Board */
    .board{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px}
    .stage{background:var(--panel);border:1px solid var(--line);border-radius:16px;position:relative;overflow:hidden}
    .legend{position:absolute;inset:10px auto auto 12px;color:var(--muted);font-size:13px}

    /* Tracks drawing */
    .tracks{position:absolute;inset:0;pointer-events:none}
    .slot-row{position:absolute;left:50%;transform:translateX(-50%);display:flex;gap:16px}
    .slot-row.top{top:60px}
    .slot-row.bottom{bottom:60px}

    .slot{width:140px;height:86px;border:1px dashed #3a457a;border-radius:12px;background:rgba(255,255,255,.02);
          display:flex;align-items:flex-end;justify-content:center;padding:6px;position:relative}
    .slot[data-side="A"]{outline:1px solid rgba(91,209,255,.18)}
    .slot[data-side="B"]{outline:1px solid rgba(255,107,107,.18)}
    .slot.highlight{box-shadow:0 0 0 2px var(--accent) inset}

    /* Card */
    .card{background:var(--card);border:1px solid #2b3a6b;border-radius:10px;padding:6px 8px;min-width:100px;max-width:100%;
          text-align:center}
    .card .type{font-size:12px;color:var(--muted)}
    .card .title{font-weight:600}
    .mods{position:absolute;left:4px;right:4px;top:4px;display:flex;flex-direction:column;gap:4px}
    .mod{font-size:11px;background:#1a2548;border:1px solid #33437a;border-radius:8px;padding:2px 6px;color:#cfe4ff;align-self:center}

    /* Right sidebar */
    .side{display:grid;grid-template-rows:auto 1fr}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}
    .hand{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .pill{font-size:12px;border:1px solid #2a355f;border-radius:999px;padding:4px 8px;display:inline-block;color:var(--muted)}
    .tabbar{display:flex;gap:8px;margin-top:6px}
    .tab{padding:6px 10px;border-radius:10px;border:1px solid #2a355f;background:#111834;cursor:pointer}
    .tab.active{background:#1a2346;color:#cfe4ff}
    .cardBtn{background:#161f3e;border:1px solid #2a355f;border-radius:10px;padding:6px 8px;cursor:pointer;text-align:left}
    .cardBtn:hover{outline:2px solid rgba(255,255,255,.06)}
    .sel{outline:2px solid var(--accent)}

    .log{background:#0e152f;border:1px solid var(--line);border-radius:12px;padding:8px;height:160px;overflow:auto;white-space:pre-wrap;color:#cdd9e5}

    /* SVG track graphic */
    svg{position:absolute;inset:0}
    .rail{stroke:#2d396b;stroke-width:14;fill:none}
    .rail-inner{stroke:#415291;stroke-width:6}
    .tie{stroke:#2a3564;stroke-width:2}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸšï¸ çµ‚æ¥µå¯©åˆ¤ï¼šé›»è»Šé›£é¡Œ â€” åˆ†å‰è»Œé“ Demoï¼ˆæ–‡å­—å¡ç‰ˆæœ¬ï¼‰</h1>
      <div class="col" style="margin-left:auto">
        <span class="pill">ç•¶å‰ç©å®¶ï¼š<b id="turnPlayer">A</b></span>
        <button class="btn" id="btnSwitch">åˆ‡æ›ç©å®¶</button>
        <button class="btn" id="btnReset">é‡ç½®å›åˆ</button>
      </div>
    </header>

    <main class="board">
      <!-- Stage / Tracks -->
      <section class="stage" id="stage">
        <div class="legend">é»é¸æ‰‹ç‰Œâ†’é»æ§½ä½å³å¯æ”¾ç½®ã€‚ç‰¹æ€§å¡ï¼šé»é¸æ‰‹ç‰Œâ†’é»å·²æ”¾ç½®çš„å¡ï¼Œå³å¯ç–ŠåŠ åˆ°ä¸Šæ–¹ã€‚</div>
        <div class="tracks">
          <!-- SVG rails -->
          <svg viewBox="0 0 1000 560" preserveAspectRatio="none" aria-hidden="true">
            <!-- main to split -->
            <path class="rail" d="M 500 560 L 500 300"/>
            <path class="rail-inner" d="M 500 560 L 500 300"/>
            <!-- fork left -->
            <path class="rail" d="M 500 300 C 500 220, 380 200, 280 160"/>
            <path class="rail-inner" d="M 500 300 C 500 220, 380 200, 280 160"/>
            <!-- fork right -->
            <path class="rail" d="M 500 300 C 500 220, 620 200, 720 160"/>
            <path class="rail-inner" d="M 500 300 C 500 220, 620 200, 720 160"/>
            <!-- ties -->
            <g class="tie">
              <line x1="480" y1="520" x2="520" y2="520"/>
              <line x1="480" y1="480" x2="520" y2="480"/>
              <line x1="480" y1="440" x2="520" y2="440"/>
              <line x1="480" y1="400" x2="520" y2="400"/>
              <line x1="470" y1="360" x2="530" y2="360"/>
              <line x1="430" y1="330" x2="570" y2="330"/>
              <line x1="385" y1="305" x2="465" y2="270"/>
              <line x1="535" y1="270" x2="615" y2="305"/>
            </g>
          </svg>

          <!-- slots (top = A, bottom = B) -->
          <div class="slot-row top">
            <div class="slot" data-side="A" data-index="0"></div>
            <div class="slot" data-side="A" data-index="1"></div>
            <div class="slot" data-side="A" data-index="2"></div>
          </div>
          <div class="slot-row bottom">
            <div class="slot" data-side="B" data-index="0"></div>
            <div class="slot" data-side="B" data-index="1"></div>
            <div class="slot" data-side="B" data-index="2"></div>
          </div>
        </div>
      </section>

      <!-- Sidebar: hands & log -->
      <aside class="side">
        <div class="panel">
          <div class="col" style="justify-content:space-between">
            <div>
              <span class="pill">ç©å®¶ Aï¼šå–„/æƒ¡/ç‰¹</span>
            </div>
            <div>
              <span class="pill">ç©å®¶ Bï¼šå–„/æƒ¡/ç‰¹</span>
            </div>
          </div>

          <div class="tabbar">
            <div class="tab active" data-tab="innocent">å–„è‰¯å¡</div>
            <div class="tab" data-tab="guilty">é‚ªæƒ¡å¡</div>
            <div class="tab" data-tab="modifier">ç‰¹æ€§å¡</div>
          </div>

          <div id="hand" class="hand"></div>
        </div>

        <div class="panel">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <strong>æ“ä½œè¨˜éŒ„</strong>
            <span class="pill">è¦å‰‡ï¼š
              <span>ç•¶å‰ç©å®¶å¯å°‡ã€å–„ã€‘æ”¾è‡ªå·±è»Œé“ã€ã€æƒ¡ã€‘æ”¾å°æ–¹è»Œé“ï¼›ã€ç‰¹ã€‘é»æ“Šç›®æ¨™å¡å¯ç–ŠåŠ ã€‚</span>
            </span>
          </div>
          <div id="log" class="log"></div>
        </div>
      </aside>
    </main>

    <footer>
      <span style="color:var(--muted)">åƒ…åŸå‹ï¼šå¡ç‰‡ä»¥æ–‡å­—å‘ˆç¾ã€‚å¾ŒçºŒå¯æŠŠåœ–ç‰‡å¡é€² card çµ„ä»¶ï¼ˆé ç•™çµæ§‹ï¼‰ã€‚</span>
    </footer>
  </div>

  <script>
  // ---------- åŸºæœ¬ç‹€æ…‹ ----------
  const state = {
    turn: 'A', // ç•¶å‰ç©å®¶ A/B
    hands: {
      A: { innocent:['å¤©æ‰é†«ç”Ÿ','å¹¼å…’åœ’è€å¸«','æ°£å€™ç§‘å­¸å®¶'], guilty:['é€ƒçŠ¯','é‚ªæ•™é ­ç›®','ç¶²è·¯è©é¨™çŠ¯'], modifier:['å…¶å¯¦æ˜¯ä½ è¡¨è¦ª','åªæœ‰ä¸€é€±å£½å‘½','å…¶ç ”ç©¶å°‡æ‹¯æ•‘ç™¾è¬äºº'] },
      B: { innocent:['æ¶ˆé˜²å“¡','æµæµªè²“æ•‘åŠ©è€…','å¿—é¡˜è€…'], guilty:['çµäººå·çµè€…','æˆ°çŠ¯','æƒ¡éœ¸æˆ¿æ±'], modifier:['æš—åœ°è£¡è³‡åŠ©æ…ˆå–„','å…¶å¯¦æ˜¯AIè¤‡è£½é«”','æœƒç™¼æ˜æ¸…æ½”èƒ½æº'] },
    },
    // è»Œé“ä¸Šä¸‰å€‹æ§½ä½ï¼Œå¡ç‰‡ç‰©ä»¶ï¼š{title, type, sidePlacedBy, mods:[]}
    track: { A:[null,null,null], B:[null,null,null] },
    selected: null, // ç•¶å‰é¸ä¸­çš„æ‰‹ç‰Œ {type,title,from:'A'|'B', index}
    activeTab:'innocent',
  };

  const logEl = document.getElementById('log');
  const handEl = document.getElementById('hand');

  function log(msg){
    const time = new Date().toLocaleTimeString();
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ---------- UI: æ‰‹ç‰Œæ¸²æŸ“ ----------
  function renderHand(){
    handEl.innerHTML = '';
    const player = state.turn;
    const cards = state.hands[player][state.activeTab];
    if (!cards || cards.length===0){
      const div = document.createElement('div');
      div.style.gridColumn = '1 / -1';
      div.style.color = 'var(--muted)';
      div.textContent = 'ï¼ˆè©²é¡å¡å·²ç”¨ç›¡ï¼‰';
      handEl.appendChild(div);
      return;
    }
    cards.forEach((title, i)=>{
      const btn = document.createElement('button');
      btn.className = 'cardBtn';
      btn.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${title}</strong><span class="pill">${tabLabel(state.activeTab)}</span></div>`;
      if (state.selected && state.selected.index===i && state.selected.from===player && state.selected.type===state.activeTab) btn.classList.add('sel');
      btn.onclick = ()=>{
        state.selected = { type: state.activeTab, title, from: player, index: i };
        renderHand();
        highlightTargets();
      };
      handEl.appendChild(btn);
    });
  }

  function tabLabel(t){ return t==='innocent'?'å–„': t==='guilty'?'æƒ¡':'ç‰¹'; }

  // ---------- UI: è»Œé“/æ§½ä½æ¸²æŸ“ ----------
  const stage = document.getElementById('stage');
  const slots = [...stage.querySelectorAll('.slot')];

  function renderTrack(){
    slots.forEach(slot=>{
      const side = slot.dataset.side; // A / B
      const idx = Number(slot.dataset.index);
      slot.innerHTML='';
      slot.classList.remove('highlight');
      const card = state.track[side][idx];
      if (card){
        const mods = document.createElement('div');
        mods.className = 'mods';
        card.mods.forEach(m=>{
          const mEl = document.createElement('div');
          mEl.className = 'mod';
          mEl.textContent = m;
          mods.appendChild(mEl);
        });
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `<div class="type">${card.type==='innocent'?'å–„è‰¯':'é‚ªæƒ¡'}ãƒ»${card.sidePlacedBy}</div><div class="title">${card.title}</div>`;
        el.dataset.side = side;
        el.dataset.index = idx;
        slot.appendChild(mods);
        slot.appendChild(el);
      }
    });
  }

  // ---------- æ”¾ç½®è¦å‰‡èˆ‡äº¤äº’ ----------
  function canPlaceOn(side, type){
    const me = state.turn;
    if (type==='innocent') return (side===me); // å–„ï¼šè‡ªå·±è»Œé“
    if (type==='guilty') return (side!==me);  // æƒ¡ï¼šå°æ–¹è»Œé“
    return false;
  }

  function firstEmptyIndex(side){
    return state.track[side].findIndex(x=>!x);
  }

  function highlightTargets(){
    slots.forEach(slot=>{
      slot.classList.remove('highlight');
      if (!state.selected) return;
      const side = slot.dataset.side;
      const idx = Number(slot.dataset.index);
      const sel = state.selected;
      if (sel.type==='modifier'){
        // ç‰¹æ€§å¡ï¼šåªèƒ½é»æ“Šå·²æœ‰å¡ç‰‡çš„æ§½
        if (state.track[side][idx]) slot.classList.add('highlight');
      } else {
        // å–„/æƒ¡å¡ï¼šä¾è¦å‰‡ä¸”ç©ºæ§½
        if (!state.track[side][idx] && canPlaceOn(side, sel.type)) slot.classList.add('highlight');
      }
    });
  }

  // é»æ“Šæ§½ä½ï¼šå˜—è©¦æ”¾ç½®
  slots.forEach(slot=>{
    slot.addEventListener('click', ()=>{
      if (!state.selected) return;
      const side = slot.dataset.side; const idx = Number(slot.dataset.index);
      const sel = state.selected; const me = state.turn;

      if (sel.type==='modifier'){
        const target = state.track[side][idx];
        if (!target){ log('ç„¡æ³•æ”¾ç½®ç‰¹æ€§å¡ï¼šæ­¤æ§½ä½æ²’æœ‰å¡'); return; }
        target.mods.push(sel.title);
        // å¾æ‰‹ç‰Œç§»é™¤
        state.hands[sel.from].modifier.splice(sel.index,1);
        state.selected = null; log(`ç©å®¶ ${me} çµ¦ã€Œ${target.title}ã€ç–ŠåŠ ç‰¹æ€§ï¼š${target.mods.slice(-1)[0]}`);
        renderAll(); return;
      }

      // å–„/æƒ¡å¡
      if (state.track[side][idx]){ log('æ­¤æ§½ä½å·²è¢«ä½”ç”¨'); return; }
      if (!canPlaceOn(side, sel.type)){ log('ä¸ç¬¦åˆæ”¾ç½®è¦å‰‡'); return; }
      const cardObj = { title: sel.title, type: sel.type, sidePlacedBy: me, mods: [] };
      state.track[side][idx] = cardObj;
      // å¾æ‰‹ç‰Œç§»é™¤
      state.hands[sel.from][sel.type].splice(sel.index,1);
      state.selected = null; log(`ç©å®¶ ${me} åœ¨è»Œé“ ${side} æ”¾ç½®ã€${sel.type==='innocent'?'å–„':'æƒ¡'}ã€‘ï¼šã€Œ${cardObj.title}ã€`);
      renderAll();
    });
  });

  // ---------- æ§åˆ¶å€ ----------
  document.getElementById('btnSwitch').onclick = ()=>{
    state.turn = state.turn==='A'?'B':'A';
    state.selected = null;
    document.getElementById('turnPlayer').textContent = state.turn;
    log(`åˆ‡æ›åˆ°ç©å®¶ ${state.turn}`);
    renderAll();
  };

  document.getElementById('btnReset').onclick = ()=>{
    state.track.A = [null,null,null];
    state.track.B = [null,null,null];
    state.selected = null;
    state.hands = JSON.parse(JSON.stringify(initialHands));
    document.getElementById('turnPlayer').textContent = (state.turn='A');
    log('å›åˆå·²é‡ç½®');
    renderAll();
  };

  const initialHands = JSON.parse(JSON.stringify(state.hands));

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      state.activeTab = t.dataset.tab;
      state.selected = null;
      renderHand();
      highlightTargets();
    });
  });

  function renderAll(){
    renderHand();
    renderTrack();
    highlightTargets();
  }

  // åˆå§‹æ¸²æŸ“
  renderAll();
  log('æç¤ºï¼šé¸æ“‡æ‰‹ç‰Œâ†’é»æ§½ä½æ”¾ç½®ï¼›é¸æ“‡ç‰¹æ€§å¡â†’é»å·²æ”¾ç½®çš„å¡ç–ŠåŠ ã€‚');
  </script>
</body>
</html>