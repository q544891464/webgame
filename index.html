<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çµ‚æ¥µå¯©åˆ¤ï¼šé›»è»Šé›£é¡Œ â€” åˆ†å‰è»Œé“ Demoï¼ˆå¼·åˆ¶å–„æƒ¡å„1 + è‡ªå‹•è¼ªåˆ°å°æ‰‹ï¼‰</title>
  <style>
    :root{ --bg:#0b1020; --panel:#0f1630; --line:#1f2a55; --fg:#e6edf3; --muted:#9aa7bd; --card:#17213f; --accent:#5bd1ff; --danger:#ff6b6b; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{padding:12px 16px}
    header{display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .btn{cursor:pointer;border:1px solid #2a355f;background:#121a36;color:var(--fg);padding:8px 12px;border-radius:10px}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .pill{font-size:12px;border:1px solid #2a355f;border-radius:999px;padding:4px 8px;display:inline-block;color:#c7d2e6}

    .board{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px}

    .stage{position:relative;background:var(--panel) center/cover no-repeat;border:1px solid var(--line);border-radius:16px;overflow:hidden;min-height:560px}
    .stage.has-bg{background-image:url('assets/track.png');}
    .legend{position:absolute;inset:auto 12px 12px 12px;color:var(--muted);font-size:13px}

    .lane{position:absolute;display:flex;gap:12px;align-items:flex-end;transform-origin:left center}
    .lane.A{top:120px;left:285px;transform:rotate(-8deg)}
    .lane.B{bottom:118px;left:285px;transform:rotate(8deg)}

    .card{background:var(--card);border:1px solid #2b3a6b;border-radius:10px;padding:6px 8px;min-width:150px;max-width:240px;position:relative}
    .card .type{font-size:12px;color:var(--muted)}
    .card .title{font-weight:700}
    .mods{margin-top:4px;display:flex;flex-direction:column;gap:2px}
    .mod{font-size:11px;background:#1a2548;border:1px solid #33437a;border-radius:8px;padding:2px 6px;color:#cfe4ff;align-self:flex-start}

    .side{display:grid;grid-template-rows:auto 1fr}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px}
    .tabbar{display:flex;gap:8px;margin-top:6px}
    .tab{padding:6px 10px;border-radius:10px;border:1px solid #2a355f;background:#111834;cursor:pointer}
    .tab.active{background:#1a2346;color:#cfe4ff}
    .hand{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    .cardBtn{background:#161f3e;border:1px solid #2a355f;border-radius:10px;padding:6px 8px;text-align:left;cursor:pointer}
    .cardBtn.sel{outline:2px solid var(--accent)}

    .log{background:#0e152f;border:1px solid var(--line);border-radius:12px;padding:8px;height:220px;overflow:auto;white-space:pre-wrap;color:#cdd9e5}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸšï¸ é›»è»Šé›£é¡Œ â€” åˆ†å‰è»Œé“ï¼ˆå¼·åˆ¶å–„æƒ¡å„1ï¼‰</h1>
      <div style="margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <span class="pill">ç•¶å‰ç©å®¶ï¼š<b id="turnPlayer">A</b></span>
        <span class="pill">éšæ®µï¼š<b id="phaseLabel">å–„è‰¯å¡</b></span>
        <button class="btn" id="btnSwitch" disabled>åˆ‡æ›ç©å®¶</button>
        <button class="btn" id="btnNext" disabled>é€²å…¥è£æ±º</button>
        <button class="btn" id="btnJudge" disabled>åˆ—è»Šé•·è£æ±º</button>
        <button class="btn" id="btnReset">é‡ç½®å›åˆ</button>
      </div>
    </header>

    <main class="board">
      <section class="stage has-bg" id="stage">
        <div class="lane A" id="laneA" data-side="A"></div>
        <div class="lane B" id="laneB" data-side="B"></div>
        <div class="legend">æµç¨‹ï¼šA/B å„åœ¨è‡ªå·±è»Œé“æ”¾ â‰¥1ã€å–„ã€‘ â†’ A/B å„åœ¨å°æ–¹è»Œé“æ”¾ â‰¥1ã€æƒ¡ã€‘ â†’ ç‰¹æ€§ï¼ˆé›™æ–¹å¯è¼ªæµå‡ºï¼‰â†’ è£æ±ºã€‚</div>
      </section>

      <aside class="side">
        <div class="panel">
          <div class="tabbar">
            <div class="tab active" data-tab="innocent">å–„è‰¯å¡</div>
            <div class="tab" data-tab="guilty">é‚ªæƒ¡å¡</div>
            <div class="tab" data-tab="modifier">ç‰¹æ€§å¡</div>
          </div>
          <div id="hand" class="hand"></div>
        </div>
        <div class="panel">
          <strong>æ“ä½œè¨˜éŒ„</strong>
          <div id="log" class="log"></div>
        </div>
      </aside>
    </main>

    <footer>
      <span class="pill">ç‰¹æ€§æœƒé¡¯ç¤ºåœ¨å¡ç‰‡ä¸‹æ–¹ï¼›åƒ…åœ¨ç‰¹æ€§éšæ®µå¯ç”¨ã€‚</span>
    </footer>
  </div>

  <script>
  // ---------- ç‹€æ…‹ ----------
  const state = {
    turn:'A',
    hands:{
      A:{innocent:['å¤©æ‰é†«ç”Ÿ','å¹¼å…’åœ’è€å¸«','æ°£å€™ç§‘å­¸å®¶'],guilty:['é€ƒçŠ¯','é‚ªæ•™é ­ç›®','ç¶²è·¯è©é¨™çŠ¯'],modifier:['å…¶å¯¦æ˜¯ä½ è¡¨è¦ª','åªæœ‰ä¸€é€±å£½å‘½','å…¶ç ”ç©¶å°‡æ‹¯æ•‘ç™¾è¬äºº']},
      B:{innocent:['æ¶ˆé˜²å“¡','æµæµªè²“æ•‘åŠ©è€…','å¿—é¡˜è€…'],guilty:['çµäººå·çµè€…','æˆ°çŠ¯','æƒ¡éœ¸æˆ¿æ±'],modifier:['æš—åœ°è£¡è³‡åŠ©æ…ˆå–„','å…¶å¯¦æ˜¯AIè¤‡è£½é«”','æœƒç™¼æ˜æ¸…æ½”èƒ½æº']},
    },
    lanes:{A:[],B:[]},
    activeTab:'innocent',
    selected:null,
    phase:'innocent', // innocent -> guilty -> modifier -> judge -> end
    requirements:{A:{innocent:false,guilty:false},B:{innocent:false,guilty:false}}
  };
  const initialHands = JSON.parse(JSON.stringify(state.hands));

  const handEl = document.getElementById('hand');
  const laneA = document.getElementById('laneA');
  const laneB = document.getElementById('laneB');
  const logEl = document.getElementById('log');
  const phaseLabel = document.getElementById('phaseLabel');
  const btnNext = document.getElementById('btnNext');
  const btnJudge = document.getElementById('btnJudge');
  const btnSwitch = document.getElementById('btnSwitch');
  const turnPlayer = document.getElementById('turnPlayer');

  const other = p=> p==='A'?'B':'A';
  const tabLabel = t => t==='innocent'?'å–„': t==='guilty'?'æƒ¡':'ç‰¹';
  function log(m){ logEl.textContent += `${new Date().toLocaleTimeString()} ${m}
`; logEl.scrollTop = logEl.scrollHeight; }

  // ---------- æ‰‹ç‰Œ ----------
  function renderHand(){
    handEl.innerHTML='';
    const me = state.turn; const list = state.hands[me][state.activeTab];
    if (!list.length){ const d=document.createElement('div'); d.style.color='var(--muted)'; d.textContent='ï¼ˆç„¡å¡ï¼‰'; handEl.appendChild(d); return; }
    list.forEach((title,i)=>{
      const btn = document.createElement('div');
      btn.className = 'cardBtn';
      if (state.selected && state.selected.from===me && state.selected.type===state.activeTab && state.selected.index===i) btn.classList.add('sel');
      btn.innerHTML = `<strong>${title}</strong> <span class="pill">${tabLabel(state.activeTab)}</span>`;
      btn.onclick = ()=>{
        // åŒå¡å†é» = å–æ¶ˆé¸ä¸­ï¼ˆåƒ…ç‰¹æ€§éšæ®µæœ‰ç”¨ï¼‰
        if (state.selected && state.selected.from===me && state.selected.type===state.activeTab && state.selected.index===i){ state.selected=null; renderHand(); return; }
        if (state.activeTab==='modifier'){
          if (state.phase!=='modifier'){ log('åƒ…åœ¨ã€ç‰¹æ€§ã€‘éšæ®µå¯é¸æ“‡ç‰¹æ€§å¡'); return; }
          state.selected = {type:'modifier', title, from:me, index:i};
          renderHand(); log(`é¸ä¸­ç‰¹æ€§å¡ï¼š${title}ï¼Œè«‹é»å ´ä¸Šç›®æ¨™å¡`);
        } else {
          // å‡ºå–„/æƒ¡å¡
          playCard({type:state.activeTab, title, from:me, index:i});
        }
      };
      handEl.appendChild(btn);
    });
  }

  // ---------- å ´ä¸Šå¡ ----------
  function renderLanes(){
    laneA.innerHTML=''; laneB.innerHTML='';
    state.lanes.A.forEach((c,i)=> laneA.appendChild(renderCardEl('A',i,c)));
    state.lanes.B.forEach((c,i)=> laneB.appendChild(renderCardEl('B',i,c)));
  }

  function renderCardEl(side, idx, card){
    const wrap = document.createElement('div'); wrap.className='card';
    wrap.innerHTML = `<div class="type">${card.type==='innocent'?'å–„è‰¯':'é‚ªæƒ¡'}ãƒ»${card.owner}</div><div class="title">${card.title}</div>`;
    const mods = document.createElement('div'); mods.className = 'mods';
    card.mods.forEach(m=>{ const d=document.createElement('div'); d.className='mod'; d.textContent=m.title; mods.appendChild(d); });
    wrap.appendChild(mods);

    // ç‰¹æ€§ï¼šé»æ“Šå·²æ”¾ç½®å¡å³å¯ç–ŠåŠ 
    wrap.addEventListener('click', ()=>{
      if (!state.selected || state.selected.type!=='modifier' || state.phase!=='modifier') return;
      const s = state.selected;
      card.mods.push({title:s.title, owner:s.from});
      state.hands[s.from].modifier.splice(s.index,1);
      state.selected=null;
      log(`åœ¨ã€Œ${card.title}ã€ä¸Šç–ŠåŠ ç‰¹æ€§ï¼š${card.mods.slice(-1)[0].title}`);
      // ç‰¹æ€§éšæ®µï¼šå¯æ‰‹å‹•ã€åˆ‡æ›ç©å®¶ã€‘ä½¿ç”¨å°æ–¹æ‰‹ç‰Œï¼Œæˆ–ä¿æŒç•¶å‰
      renderAll();
    }, true);

    return wrap;
  }

  // ---------- å‡ºç‰Œé‚è¼¯ï¼ˆè‡ªå‹•è¼ªåˆ°å°æ‰‹ï¼‰ ----------
  function playCard(sel){
    if (!sel) return;
    if (sel.type==='modifier'){ return; }
    if (state.phase!==sel.type){ log(`ç•¶å‰éšæ®µæ˜¯ã€${phaseName(state.phase)}ã€‘ï¼Œä¸èƒ½å‡ºã€${tabLabel(sel.type)}ã€‘`); return; }

    const me = state.turn; let side=null;
    if (sel.type==='innocent'){ side=me; state.requirements[me].innocent=true; }
    if (sel.type==='guilty'){ side=other(me); state.requirements[me].guilty=true; }

    const cardObj = {title:sel.title, type:sel.type, owner:me, mods:[]};
    state.lanes[side].push(cardObj);
    state.hands[sel.from][sel.type].splice(sel.index,1);
    log(`ç©å®¶ ${me} åœ¨è»Œé“ ${side} å‡ºã€${tabLabel(sel.type)}ã€‘ã€Œ${sel.title}ã€`);

    // å‡ºç‰Œå¾Œï¼šè‹¥å°æ‰‹åœ¨æœ¬éšæ®µå°šæœªå®Œæˆå…¶ã€è‡³å°‘1å¼µã€‘çš„è¦æ±‚ â†’ è¼ªåˆ°å°æ‰‹
    if (state.phase==='innocent'){
      if (!state.requirements[other(me)].innocent) state.turn = other(me);
    } else if (state.phase==='guilty'){
      if (!state.requirements[other(me)].guilty) state.turn = other(me);
    }

    // è‹¥é›™æ–¹éƒ½å·²æ»¿è¶³ï¼Œæ¨é€²åˆ°ä¸‹ä¸€éšæ®µ
    if (state.phase==='innocent' && state.requirements.A.innocent && state.requirements.B.innocent){
      state.phase='guilty'; state.turn='A'; state.activeTab='guilty'; updatePhase();
      log('å·²é€²å…¥ã€é‚ªæƒ¡å¡ã€‘éšæ®µï¼šA/B éœ€å„å‘å°æ–¹è»Œé“è‡³å°‘å‡º 1 å¼µ');
    } else if (state.phase==='guilty' && state.requirements.A.guilty && state.requirements.B.guilty){
      state.phase='modifier'; state.turn='A'; state.activeTab='modifier'; updatePhase();
      log('å·²é€²å…¥ã€ç‰¹æ€§ã€‘éšæ®µï¼šé›™æ–¹å¯åœ¨ä»»ä¸€å¡ä¸Šç–ŠåŠ ç‰¹æ€§ï¼Œå®Œæˆå¾Œé»ã€Œé€²å…¥è£æ±ºã€');
    }

    renderAll();
  }

  // ---------- è£æ±º / éšæ®µæ§åˆ¶ ----------
  btnNext.onclick = ()=>{ if (state.phase==='modifier'){ state.phase='judge'; updatePhase(); } };
  btnJudge.onclick = ()=>{
    const side = prompt('åˆ—è»Šé•·é¸æ“‡æ’å“ªæ¢è»Œé“ï¼Ÿè¼¸å…¥ A æˆ– B');
    if (side==='A'||side==='B'){ log(`åˆ—è»Šé•·è£æ±ºï¼šæ’ ${side} è»Œé“`); state.phase='end'; updatePhase(); }
  };
  btnSwitch.onclick = ()=>{ if (state.phase==='modifier'){ state.turn = other(state.turn); updateHeader(); renderHand(); } };

  function phaseName(p){ return p==='innocent'?'å–„è‰¯å¡': p==='guilty'?'é‚ªæƒ¡å¡': p==='modifier'?'ç‰¹æ€§å¡': p==='judge'?'è£æ±º':'çµæŸ'; }
  function updateHeader(){
    turnPlayer.textContent = state.turn;
    phaseLabel.textContent = phaseName(state.phase);
    btnNext.disabled = state.phase!=='modifier';
    btnJudge.disabled = state.phase!=='judge';
    btnSwitch.disabled = state.phase!=='modifier';
  }

  // ---------- æ§åˆ¶ ----------
  document.getElementById('btnReset').onclick = ()=>{
    state.lanes={A:[],B:[]}; state.hands=JSON.parse(JSON.stringify(initialHands));
    state.turn='A'; state.phase='innocent'; state.activeTab='innocent'; state.selected=null;
    state.requirements={A:{innocent:false,guilty:false},B:{innocent:false,guilty:false}};
    log('å›åˆå·²é‡ç½®'); updateHeader(); renderAll();
  };

  // Tabsï¼šåƒ…å…è¨±åˆ‡åˆ°ç•¶å‰éšæ®µå°æ‡‰çš„æ‰‹ç‰Œ
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      const want = t.dataset.tab;
      if (want!==state.phase){ log(`ç¾åœ¨è™•æ–¼ã€${phaseName(state.phase)}ã€‘éšæ®µï¼Œç„¡æ³•åˆ‡åˆ°ã€${tabLabel(want)}ã€‘`); return; }
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active'); state.activeTab=want; state.selected=null; renderHand();
    });
  });

  function renderAll(){ renderLanes(); renderHand(); updateHeader(); }
  renderAll();
  log('æç¤ºï¼šA/B åœ¨å–„/æƒ¡éšæ®µå„è‡³å°‘å‡º 1 å¼µç‰Œã€‚å‡ºç‰Œå¾Œè‡ªå‹•æ›åˆ°å°æ‰‹ï¼›å…©é‚Šéƒ½æ»¿è¶³å¾Œæ‰é€²å…¥ä¸‹ä¸€éšæ®µã€‚ç‰¹æ€§æœƒé¡¯ç¤ºåœ¨å¡ç‰‡ä¸‹æ–¹ã€‚');
  </script>
</body>
</html>
